#!/usr/bin/env bash
set -euo pipefail

# Override default location of env file.
#export SSH_AGENT_CANON_ENV_FILE="${XDG_RUNTIME_DIR:-"/tmp/user/$(id --user)"}/ssh-agent-canonicalize/env.source"
# Default location of env file.
SSH_AGENT_CANON_DEFAULT_ENV_FILE="${XDG_RUNTIME_DIR:-"/tmp/user/$(id --user)"}/ssh-agent-canonicalize/env.source"

ENV_FILE="${SSH_AGENT_CANON_ENV_FILE:-"$SSH_AGENT_CANON_DEFAULT_ENV_FILE"}"

function canon_agent_pid() {
  (
    unset SSH_AGENT_PID
    source "$ENV_FILE" >/dev/null
    echo ${SSH_AGENT_PID:-}
  )
}

function non_canon_agent_pids() {
  echo $(pgrep ssh-agent) | sed -e "s#\b$(canon_agent_pid)\b##"
}

function is_canon_agent_running() {
  ps -p "$(canon_agent_pid)" 2>/dev/null | grep -q ssh-agent
}

function kill_non_canon_agents() {
  non_canon_agent_pids | xargs --no-run-if-empty kill -TERM
}

function seed_agent() {
  (
    source "$ENV_FILE" >/dev/null
    if ! ssh-add -l 2>&1 >/dev/null; then
      ssh-add
    fi
  )
}

function main() {
  mkdir -p "$(dirname "$ENV_FILE")"
  touch "$ENV_FILE"

  kill_non_canon_agents

  if ! is_canon_agent_running; then
    ssh-agent >"$ENV_FILE"
  fi

  seed_agent

  cat "$ENV_FILE"
}

main
